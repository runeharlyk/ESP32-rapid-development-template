<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BLE Chat</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <style>
      #tempDisplay {
        font-size: 24px;
        margin: 20px 0;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
      }
      input {
        padding: 8px;
        margin: 5px;
      }
      #log {
        height: 200px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ESP32 BLE Control</h1>
      <button id="connect">Connect</button>
      <button id="disconnect" disabled>Disconnect</button>
      <div id="tempDisplay">Temperature: --</div>
      <div>
        <input
          id="command"
          type="number"
          placeholder="Enter command value..."
        />
        <button id="send" disabled>Send Command</button>
      </div>
      <pre id="log"></pre>
    </div>

    <script>
      const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
      const CHARACTERISTIC_TX_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
      const CHARACTERISTIC_RX_UUID = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

      let device, txChar, rxChar;

      const log = (msg) => {
        document.getElementById("log").textContent += msg + "\n";
        document.getElementById("log").scrollTop = 1e9;
      };

      document.getElementById("connect").onclick = async () => {
        device = await navigator.bluetooth.requestDevice({
          acceptAllDevices: true,
          optionalServices: [SERVICE_UUID],
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        txChar = await service.getCharacteristic(CHARACTERISTIC_TX_UUID);
        rxChar = await service.getCharacteristic(CHARACTERISTIC_RX_UUID);
        await txChar.startNotifications();
        txChar.addEventListener("characteristicvaluechanged", (e) => {
          const dec = new TextDecoder();
          const data = dec.decode(e.target.value);
          log("RX: " + data);

          if (data.startsWith("TEMP:")) {
            const temp = parseFloat(data.substring(5));
            document.getElementById(
              "tempDisplay"
            ).textContent = `Temperature: ${temp.toFixed(2)}`;
          }
        });
        document.getElementById("disconnect").disabled = false;
        document.getElementById("send").disabled = false;
        document.getElementById("connect").disabled = true;
        log("Connected");
      };

      document.getElementById("disconnect").onclick = async () => {
        if (device && device.gatt.connected) {
          await device.gatt.disconnect();
          log("Disconnected");
        }
        document.getElementById("disconnect").disabled = true;
        document.getElementById("send").disabled = true;
        document.getElementById("connect").disabled = false;
        document.getElementById("tempDisplay").textContent = "Temperature: --";
      };

      document.getElementById("send").onclick = async () => {
        const input = document.getElementById("command");
        const value = input.value;
        if (value) {
          const cmdStr = "CMD:" + value;
          const enc = new TextEncoder();
          const data = enc.encode(cmdStr);
          await rxChar.writeValue(data);
          log("TX: " + cmdStr);
          input.value = "";
        }
      };
    </script>
  </body>
</html>
